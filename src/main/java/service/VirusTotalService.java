package service;

import com.mashape.unirest.http.HttpResponse;
import com.mashape.unirest.http.Unirest;
import com.mashape.unirest.http.exceptions.UnirestException;
import model.FileReport;
import transformer.ReportTransformer;

import java.io.File;
import java.io.FileNotFoundException;
import java.util.Scanner;

public class VirusTotalService {

    private static final String VIRUSTOTAL_FILE_REPORT_URI = "https://www.virustotal.com/vtapi/v2/file/report";
    private static final String VIRUSTOTAL_API_KEY = getApiKey();

    private ReportTransformer reportTransformer = new ReportTransformer();

    public VirusTotalService() {
        Unirest.setObjectMapper(new json.mapper.ObjectMapper());
    }

    public FileReport getFileReport(String fileHash) throws UnirestException {
        HttpResponse<json.FileReport> fileReportResponse = Unirest.post(VIRUSTOTAL_FILE_REPORT_URI)
                .queryString("resource", fileHash)
                .queryString("apikey", VIRUSTOTAL_API_KEY)
                .asObject(json.FileReport.class);

        return reportTransformer.transformFileReport(fileReportResponse.getBody());
    }

    private static String getApiKey() {
        try {
            return new Scanner(new File("api.key")).next();
        } catch (FileNotFoundException e) {
            throw new RuntimeException(e);
        }
    }

    public static void main(String[] args) throws UnirestException {
        VirusTotalService virusTotalService = new VirusTotalService();
        FileReport fileReport = virusTotalService.getFileReport("e1112134b6dcc8bed54e0e34d8ac272795e73d74");
    }
}
